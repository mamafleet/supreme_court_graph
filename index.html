<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Supreme Court Case Graph</title>
  <style>
    body { margin: 0; background: #111; color: #fff; font-family: sans-serif; }
    #3d-graph { width: 100vw; height: 100vh; display: block; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.8);
      padding: 10px;
      border-radius: 8px;
      z-index: 10;
    }
    label, select {
      color: white;
      font-size: 14px;
    }
  </style>

  <!-- Scripts -->
  <script src="https://unpkg.com/3d-force-graph"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/geometries/ConvexGeometry.min.js"></script>
</head>
<body>

<div id="3d-graph"></div>
<div id="controls">
  <label for="topicFilter">Filter by topic:</label><br/>
  <select id="topicFilter">
    <option value="All">All</option>
    <option value="Constitutional Law">Constitutional Law</option>
    <option value="Digital Speech">Digital Speech</option>
    <option value="Environmental/Admin Law">Environmental/Admin Law</option>
    <option value="Criminal Law / Due Process">Criminal Law / Due Process</option>
    <option value="Consumer Finance / Contracts">Consumer Finance / Contracts</option>
    <option value="Copyright / Civil Liability">Copyright / Civil Liability</option>
    <option value="Employment & Commerce">Employment & Commerce</option>
  </select>
</div>

<script>
  const topicColors = {
    "Constitutional Law": "dodgerblue",
    "Digital Speech": "skyblue",
    "Environmental/Admin Law": "mediumseagreen",
    "Criminal Law / Due Process": "goldenrod",
    "Consumer Finance / Contracts": "salmon",
    "Copyright / Civil Liability": "orchid",
    "Employment & Commerce": "lightgray",
    "Uncategorized": "white"
  };

  let Graph, originalData, currentHulls = [];

  const drawConvexHulls = () => {
    // Remove existing hulls
    currentHulls.forEach(h => Graph.scene().remove(h));
    currentHulls = [];

    const topicGroups = {};
    originalData.nodes.forEach(n => {
      const obj = Graph.getObject3D(n.id);
      if (!obj || !obj.position) return;
      if (!topicGroups[n.topic]) topicGroups[n.topic] = [];
      topicGroups[n.topic].push(obj.position.clone());
    });

    for (const [topic, points] of Object.entries(topicGroups)) {
      if (points.length < 3) continue;
      const geometry = new THREE.ConvexGeometry(points);
      const material = new THREE.MeshBasicMaterial({
        color: topicColors[topic] || "white",
        opacity: 0.1,
        transparent: true,
        depthWrite: false
      });
      const mesh = new THREE.Mesh(geometry, material);
      currentHulls.push(mesh);
      Graph.scene().add(mesh);
    }
  };

  const filterGraph = topic => {
    if (!originalData) return;
    if (topic === "All") {
      Graph.graphData(originalData);
    } else {
      const nodes = originalData.nodes.filter(n => n.topic === topic);
      const nodeIds = new Set(nodes.map(n => n.id));
      const links = originalData.links.filter(l => nodeIds.has(l.source) && nodeIds.has(l.target));
      Graph.graphData({ nodes, links });
    }
    setTimeout(drawConvexHulls, 1200);
  };

  fetch("case_similarity_graph_grouped.json")
    .then(res => res.json())
    .then(data => {
      originalData = data;

      Graph = ForceGraph3D()
        (document.getElementById("3d-graph"))
        .graphData(data)
        .nodeLabel(n => `${n.id} [${n.topic}]`)
        .nodeColor(n => topicColors[n.topic] || "white")
        .linkOpacity(0.25)
        .linkWidth(l => l.value * 5)
        .linkColor(() => "#888");

      // Initial hull draw
      setTimeout(drawConvexHulls, 2000);
    });

  document.getElementById("topicFilter").addEventListener("change", e => {
    filterGraph(e.target.value);
  });
</script>
</body>
</html>
